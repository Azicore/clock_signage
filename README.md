# Raspberry Pi用オリジナル時計サイネージ

noteに簡単な製作記を投稿しました。まずはこちらをお読み下さい。

* https://note.com/azicore/n/na8fcca7d4bed
* https://note.com/azicore/n/n1579bf70e407 （続編）
* https://note.com/azicore/n/n5f0d3935cba2 （センサー接続編）

※記事執筆後も改良を続けているため、一部記事の内容と仕様が変わっている部分があります。

## 注意

* 私的な作品ですので、改善依頼やプルリクエスト等は受け付けません。
* 当リポジトリ内のコードの使用や以下に説明の手順の実行は、全て自己責任にてお願いいたします。
* 本作品に関する質問は、Twitter（[@Azicore](https://twitter.com/Azicore)）で受け付けます。

## 推奨環境

* Raspberry Pi 4 Model Bで実行することを前提としています。
* 13インチ程度のサイズで、横縦比16:9のモニターで表示することを想定しています。
* 「環境モニター」を実行するには、別途センサー部品の接続が必要です。詳細は「センサー接続編」のnote記事をご覧下さい。

## 機能紹介

* 基本機能
  * OS起動時に自動的にブラウザのキオスクモードを使用して全画面で起動します。
  * 同じWiFiに接続したスマホ等の別デバイスをリモコンとして使用し、以下の各アプリを切り替えることができます。
* 時計サイネージ
  * 1つの画面にカレンダー、アナログ時計、天気予報、メッセージを表示するアプリです。
  * 小さな子供が読めるように、文字は全てひらがなにしました。
  * メッセージは15秒ごとに切り替わり、任意の条件で任意のメッセージを表示させるよう設定できます。
* デジタル時計
  * 黒背景の中、シンプルなデジタル時計がただゆっくり動きながら時を刻み続けるだけのスクリーンセーバーアプリです。
  * 数字が切り替わるときのアニメーションが特徴です。
* 再起動/シャットダウン
  * リモコン上のボタン1つで、Raspberry Pi本体の再起動・シャットダウンを安全に行なうことができるアプリです。
* フォトスライドショー
  * 写真や画像のファイルをスライドショーにして表示するアプリです。
  * 画像が切り替わるときの3次元的なアニメーションが特徴です。
* 書き順
  * ひらがなとカタカナの書き順のアニメーションをひたすら表示するアプリです。
  * 小さな子供が眺めて書き順を覚える手助けになるように作りました。
* 環境モニター
  * 温湿度・気圧センサー「BME280」とCO2センサー「MH-Z19C」から計測値を取得して折れ線グラフで表示するアプリです。
  * アプリを表示していないときでもバッチ処理により常に計測値を記録しておくことができます。
* キーボード
  * 子供が本物のキーボードでローマ字入力の練習をできるようにするためのアプリです。
  * このアプリの使用時には、Raspberry Pi本体にキーボードを接続する必要があります。

## ファイル構成

### 主要ファイル：

* `startup.sh` … OS起動時にcrontabに叩かれるスクリプトです。
* `server.js` … Node.jsによるウェブサーバーです。`startup.sh`により起動します。
* `main/display.html` … 外枠ページです。Raspberry Pi上のブラウザで表示し、`<iframe>`でアプリの画面を読み込みます。
* `main/index.html` … リモコンページです。スマホ等の別デバイスで表示し、`display.html`が読み込むアプリを切り替えることができます。

### 各アプリディレクトリ内

* `index.html`は、そのアプリの本体ページです。
* `components`ディレクトリは、そのアプリの主要なJSモジュールファイルが入っています。
* `config.js`は、設定ファイルです。複数の設定ファイルがある場合は`config`ディレクトリに入れています。

## デプロイ方法

※Raspberry Pi自体のセットアップについては省略しています。環境に合わせて以下の手順は適宜読み替えて下さい。

### 基本の設定

1. 本リポジトリのルートディレクトリを、`/home/pi/www/`などに設置し、ドキュメントルートとする。
1. 「`crontab crontab.txt`」でcrontabを設定する。
1. 「`sudo apt install unclutter`」でunclutterをインストールする。
1. 「`curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.1/install.sh | bash`」でnvmをインストールする。
1. 「`. ~/.bashrc`」を実行してnvmを有効化し、「`nvm install 18`」でNode.jsをインストールする。
1. 「`npm install`」で依存モジュールをインストールする。
1. Chromiumの設定画面で「設定 > プライバシーとセキュリティ > サイトの設定 > 音声」を開き、許可サイトに「`http://localhost:ポート番号`」を追加しておく。
1. 「`sudo shutdown -r now`」で再起動する。

### センサーの設定

「環境モニター」でセンサーを接続する場合は、上記に加えて以下の設定が必要です。

1. 「`sudo raspi-config`」で設定画面を開く。
1. 「Interface Options > I2C」を選択し、I2Cを有効にする。
1. 「Interface Options > Serial Port」を選択し、シリアル通信を有効にする（Login shellの質問にはNo、有効化の質問にYesと回答する）。
1. 「`sudo shutdown -r now`」で再起動する。
1. `envmonitor/batch/`ディレクトリへ移動し、「`npm install`」でバッチの依存モジュールをインストールする。
1. 「`cat <(crontab -l) crontab.txt | crontab`」でcrontabにバッチの設定を追加する。

## 運用方法

### 時計サイネージ

* メッセージを修正・追加する場合は、`signage/config/messages.js`を修正して下さい。
* 祝日を修正・追加する場合は、`signage/config/holidays.js`を修正して下さい。
* 画面上で、半角数字・ひらがな・カタカナ以外の文字種を使用する場合はサブセットフォントの作り直しが必要です。

### その他

* ウェブサーバーのポート番号を変更するには、`startup.sh`の`HTTP_PORT`、`WS_PORT`を変更して下さい。
* アプリを追加するには、`signage`や`floating_clock`同様にディレクトリを切り、`main/main.js`にパスと名前を追加すると、リモコンにボタンが追加されます。

## 更新履歴

* `CHANGELOG.md`を参照して下さい。
